<?php
// import the Joomla modellist library
jimport('joomla.application.component.modelitem');

/**
 *
 * WebForms Model
 * @author PURJUS DEV TEAM
 *
 */
class RrgDevModelWebforms extends JModelItem {

	// Class members
	private $webform = null;
	private $url = null;
	private $helper_lmt_config = array();
	private $helper_lmt_decript = array();

	/**
	 * Fait son possible pour que l'envoie à lmt ne plante pas.
	 * Supprime le dernier caractère(si spécial qui s'encore sur plusieurs caractère)
	 * Redécoupe la string en fonction de la taille demander
	 * Ne fait pas le café.
	 *
	 * @param string $string
	 * @param int $leng
	 */
	private function formatString($string, $leng) {
		$test = false;
		$return = null;
		$buff = null;
		$i = 0;
		//On encore et on coupe
		$return = substr(urlencode($string), 0, $leng);
		//Si on est arriver à la taille max il est possible qu'un caractère
		//encodé est été coupé ... sa fait planter lmt.
		if (strlen($return) == $leng) {
			$buff = substr($return, -3);
			$buff = str_split($buff);
			foreach ($buff as $carac) {
				if ($carac == '%') {
					$test = true;
					break;
				} else {
					$i++;
				}
			}
			//En fonction de la position du "%" on sait combien on doit enlever de caractère
			//Pour avoir tous les caractères encoder en entier
			switch ($i) {
				case 1:
					$return = substr($return, 0, $leng - 2);
					break;

				case 2:
					$return = substr($return, 0, $leng - 1);
					break;

				default:
					break;
			}
		}
		return $return;
	}

	/**
	 * Dans le cas d'un Vn,
	 * Renvoi le type LMT de lead
	 * *Brochure dans un cas, Essai dans tous les autres.
	 */
	private function getLmtVnSousType() {
		$result = null;
		//On récupère le type de lead remplie (champ caché dans le form)
		if (JRequest::getString('type') == 'brochure') {
			$result = 'vn_brochure';
		} else {
			$result = 'vn';
		}

		return $result;
	}

	/**
	 *  Construit le commentaire additionnel pour les Vo/Vn
	 *
	 * @return Le commentaire qui définie la demande client
	 *   Reservation et essai
	 */
	private function miseEnFormeSsDem() {
		$tab = array();
		$tab['reservation'] = '[DEMANDE D\'ACHAT] ';
		$tab['normal'] = '[DEMANDE DE CONTACT] ';
		$tab['essai'] = '[DEMANDE D\'ESSAI] ';

		// Commentaire specifique pour le mini site twizy
		if (JRequest::getString('view') == 'twizy') {
			return '[OPO Twizy du 19-23 avril]';
		}
			
		return $tab[JRequest::getString('type')];
	}

	/**
	 * Retourne l'idWebform d'un formulaire, LMT, graçe aux paramètres.
	 *
	 * @param String $etat
	 * @param String $server
	 * @param String $type_formulaire
	 * @return string|boolean
	 */
	public function getLmtIdWebForm($etat, $server, $type_formulaire) {
		 
		// Appel du helper pour récupération de l'url
		require_once (JPATH_ADMINISTRATOR . DS . 'components' . DS . 'com_rrgdev' . DS . 'helpers' . DS . 'webform.php');
		$lmt_flux = WebFormHelper::getLmtFluxUrls();
		// On execute l'appel et on enregistre le raw
		$url = $lmt_flux[$etat][$server][$type_formulaire];
		//die(var_dump($url));
		$handle = fopen($url, 'r');
		$content = '';

		if ($handle) {
			$content = stream_get_contents($handle);
			fclose($handle);
		}

		// On parse la réponse, pour récupérer le lmt_id
		$xml = simplexml_load_string($content);
		$lmt_idwebform = (string) $xml->idWebform;
		 
		if (!empty($lmt_idwebform))
		{

			return '&idWebform=' . $lmt_idwebform;
		}
		elseif (empty($lmt_idwebform))
		{
			echo "NEIN";
			return false;
		}
	}

	/**
	 * Renvoie le type de lead formaté pour LMT
	 * En fonction du contexte d'appel (page ou l'on se trouve)
	 *
	 * @return type de lead
	 */
	public function getLeadType() {

		$result = false;
		// Dans un premier temps on trie en fonction de l'option
		// Pour la suite c'est spécifique au cas par cas
		// ATTENTION: ne fonctionne que pour la soumission par le web. Par l'iphone,
		// pas de &option=com_... donc il faut découvrir le truc autrement!
		switch (JRequest::getString('option')) {
			case 'com_rrg_vo':
				if (JRequest::getString('operation') == 'sslo')
				{
					$result = 'sslo';
					break;
				}
				$result = 'vo';
				break;

			case 'com_rrg_vn':
				//si ce n'est pas un essai
				$result = $this->getLmtVnSousType();
				break;

			case 'com_rrg_commande':

				switch (JRequest::getString('type')) {
					case 'VN':

						$result = 'boutique_vn';
				 	break;
					case 'VO':
						$result = 'boutique_vo';
				 	break;
					default:
						;
				 	break;
				}
				break;
			case 'com_rrg_apv':
				switch (JRequest::getString('planning')) {
					case 'classique':
						$result = 'apv_standart';
						break;
					case 'promos':
						$result = 'apv_promos';
						break;
					default:
						$result = false;
					break;
				}
				break;

			case 'com_rrg_form':
				// attention, dans rrg_form, la vue par defaut est simple... si un lien le précise pas explicitement,
				// (index.php?option=com_rrg_form tout court) on se fait avoir, du coup on met ici aussi la valeur par défaut.
				switch (JRequest::getString('view', 'simple')) {
					case 'simple':
						$result = 'demande_generale';
						break;

					case 'zemodeles':
						$result = 'ze';
						break;

					case 'daciapromo':
						$result = 'dacia_promo';
						break;
					case 'contratservices':
						$result = 'contrat_services';
						break;
					case 'agentsorleans':
						$result = 'demande_generale';
						break;
					case 'twizy':
						$result = 'twizy';
						break;
					default:
						$result = false;
					break;
				}
				break;
			case 'com_rrg_etablissements':

				$result = 'demande_generale';
				break;
		}
		if (empty($result)) {
			$tmp = JRequest::getString('method', ''); // leadapv.save
			$method = explode('.', $tmp);

			if (count($method) != 2) {
				return false;
			}
			switch ($method[0]) {
				case 'leadapv':
					$result = 'apv_standart';
					break;
				case 'leadvn':
					$result = 'vn';
					break;
				case 'leadvo':
					$result = 'vo';
					break;
				default:
					$result = false;
				break;
			}
		}
		return $result;
	}

	/**
	 *
	 * Retourne la requete d'injection LMT.
	 * @return string
	 */
	public function getUrlRequestType($mobile = null) {
		// @todo les mettres en membre de classe
		$helper_lmt_config = WebFormHelper::getConfigLmt();
		$helper_lmt_decript = WebFormHelper::getTranslationPurjusLmt();

		$type = $this->getLeadType();

		if (!$type) {
			return false;
		}

		// !! ATTENTION A BIEN METTRE URL !!
		//$url_base = "http://staging-valid.renault.fr/leadforms/service/post?submit=";
		$url_base = "http://www.renault.fr/leadforms/service/post?submit=";

		// Selection de la variable de Context en fonction de l'origine du lead
		if($mobile == true)
		{
			//C'est un lead mobile
			$url_origin = '&CONTEXT=F6rrg-mobile';
		}
		else
		{
			//C'est un lead non mobile
			$url_origin = '&CONTEXT=F6rrg';

		}
		$url_params_dur = '&idPart=PURJUS&local=fr_FR';
		$idwebform = $this->getLmtIdWebForm($helper_lmt_config['server'], $helper_lmt_config['etat'], $type);
		$webform_dealer_id = '&WEBFORM_DEALER_ID=';
		$tmp_dealer_id = null;
		$meta_constructor = '&META_CONSTRUCTOR=RENAULT';

		// Si c'est autre chose qu'une commande
		if (JRequest::getString('option') != 'com_rrg_commande')
		{
			// PERSONNE
			JRequest::getBool('mailing') ? $dclispec_optin = '&DCLISPEC_OPTIN=True' : $dclispec_optin = '&DCLISPEC_OPTIN=False';
			$dclicom_cd_titre = '&DCLICOM_CD_TITRE=' . $helper_lmt_decript['client'][urlencode(JRequest::getString('civilite'))];
			$dclicom_e_mail = '&DCLICOM_E_MAIL=' . $this->formatString(JRequest::getString('mail'), 255);
			$dclicom_nom = '&DCLICOM_NOM=' . $this->formatString(JRequest::getString('nom'), 255);
			$dclicom_prenom = '&DCLICOM_PRENOM=' . $this->formatString(JRequest::getString('prenom'), 255);
			$dclicom_n_tel_port = '&DCLICOM_N_TEL_PORT=' . $this->formatString(JRequest::getString('telephone'), 255);
			$dclicom_n_tel_dom = '&DCLICOM_N_TEL_DOM=' . $this->formatString(JRequest::getString('telephone'), 255);
			$dclicom_code_postal = '&DCLICOM_CODE_POSTAL=' . $this->formatString(JRequest::getString('cp'), 10);
			$dclicom_localite = '&DCLICOM_LOCALITE=' . $this->formatString(JRequest::getString('ville'), 50);

			$adresse = JRequest::getString('adresse');

			if (strlen($adresse) <= 50) {
				$dclicom_nom_voie = '&DCLICOM_NOM_VOIE=' . urlencode($adresse);
				$dclicom_comp_adresse = '&DCLICOM_COMP_ADRESSE=';
			} else {
				$dclicom_nom_voie = '&DCLICOM_NOM_VOIE=' . substr(urlencode($adresse), 0, 50);
				$dclicom_comp_adresse = '&DCLICOM_COMP_ADRESSE=' . substr(substr(urlencode($adresse), 50), 0, 255);
			}
		}
		else // Sinon c'est un utilisateur de la boutique
		{
			$modelUser = JModel::getInstance('user', 'RrgDevModel');
			$user = $modelUser->getUser($modelUser->getUserId());
			$userAdrFact = $user->adr_fact;
			// PERSONNE
			$user->acceptcontact ? $dclispec_optin = '&DCLISPEC_OPTIN=True' : $dclispec_optin = '&DCLISPEC_OPTIN=False';
			$dclicom_cd_titre = '&DCLICOM_CD_TITRE=' . $helper_lmt_decript['client'][urlencode($user->civilite)];
			$dclicom_e_mail = '&DCLICOM_E_MAIL=' . $this->formatString($user->mail, 255);
			$dclicom_nom = '&DCLICOM_NOM=' . $this->formatString($user->nom, 255);
			$dclicom_prenom = '&DCLICOM_PRENOM=' . $this->formatString($user->prenom, 255);
			$dclicom_n_tel_port = '&DCLICOM_N_TEL_PORT=' . $this->formatString($user->tel_port, 255);
			$dclicom_n_tel_dom = '&DCLICOM_N_TEL_DOM=' . $this->formatString($user->tel_fixe, 255);
			$dclicom_code_postal = '&DCLICOM_CODE_POSTAL=' . $this->formatString($userAdrFact->cp, 10);
			$dclicom_localite = '&DCLICOM_LOCALITE=' . $this->formatString($userAdrFact->ville, 50);

			$adresse = $userAdrFact->rue ." ".$userAdrFact->complement;

			if (strlen($adresse) <= 50) {
				$dclicom_n_voie = '&DCLICOM_N_VOIE='.$userAdrFact->num;
				$dclicom_nom_voie = '&DCLICOM_NOM_VOIE=' . urlencode($adresse);
				$dclicom_comp_adresse = '&DCLICOM_COMP_ADRESSE=';
			} else {
				$dclicom_n_voie = '&DCLICOM_N_VOIE='.$userAdrFact->num;
				$dclicom_nom_voie = '&DCLICOM_NOM_VOIE=' . substr(urlencode($adresse), 0, 50);
				$dclicom_comp_adresse = '&DCLICOM_COMP_ADRESSE=' . substr(substr(urlencode($adresse), 50), 0, 255);
			}
		}

		//$dclicom_nom_voie = '&DCLICOM_NOM_VOIE=' . urlencode(JRequest::getString('adresse'));
		$info_personne = $dclicom_cd_titre . $dclicom_e_mail . $dclicom_nom . $dclicom_prenom . $dclicom_n_tel_port ;
		$info_personne .= $dclicom_n_tel_dom .$dclicom_code_postal . $dclicom_localite . $dclicom_nom_voie . $dclicom_comp_adresse;

		switch ($type) {
				
			case 'boutique_vn':
				$model = JModel::getInstance('leadachatvn', 'RrgDevModel');
				$modelEtab = JModel::getInstance('Etablissement', 'RrgDevModel');
				$modelCommande = JModel::getInstance('Commande', 'RrgDevModel');
				$modelUser = JModel::getInstance('user', 'RrgDevModel');
				$user = $modelUser->getUser($modelUser->getUserId());
				$vn = $model->getObjectif();
				$commande = $modelCommande->getItem();
				$tmp_dealer_id = $modelEtab->getDealerIdByCompteDistribution($vn->compte_distribution_id);
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE='. $helper_lmt_decript['server'][$type]['sous_demande'];
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				//CONTACT PREF
				$tmp = ($dclispec_optin) ? 'True' : 'False';
				$dclicom_contact_pref = '&DCLISPEC_CONTACT_EMAIL=' . $tmp;
				//VEH_CLIENT
				$dclicom_basket= "&INT_BASKET=".$vn->modele;

				//PAS ENCORE DISPONNIBLE
				//$dclicom_chassis= "&INT_CHASSIS=";
				//$dclicom_contrat_service= "&INT_CONTRACT_SERVICE=";
				//$dclicom_promotion= "&INT_PROMOTION=";
				//$dclicom_offer= "&INT_OFFER=";

				// Récupération INFO Spécifique à ce lead
				//OBJECTIF
				$dclicom_semiclair= "&INT_SEMICLAIR=".$vn->version;
				$dclicom_tarif_origine= "&INT_TARIF_ORIGINE=".$vn->numero_tarif;
				$dclicom_energie= "&INT_ENERGIE".$vn->energie;
				$dclicom_marque = '&INT_MARQUE=' . $this->formatString($vn->marque, 50);
				$dclicom_modele = '&INT_MODELE=' . $this->formatString($vn->modele, 50);
				$dclicom_carrosserie = '&INT_CARROSSERIE='.$this->formatString($vn->categorie, 50);
				$dclicom_vin = '&INT_CHASSIS=' . $this->formatString($vn->vin, 50);
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . $this->formatString(JRequest::getInt('contrats'), 50);
				$dclicom_fin = '&INT_FIN=' . $this->formatString(JRequest::getInt('financement'), 50);
				$dclicom_prix = '&INT_PRICE=' . $this->formatString($vn->prix_ttc, 50);
				$dclicom_version = '&INT_VERSION=' . $this->formatString($vn->version, 50);

				//ON prend la premiere voiture comme voiture par défaut.
				if($user->vehicules['0'] != null)
				{
					$user_voiture = $user->vehicules['0'];
					//Alors on peut remplir les information de vehicule possedé
					$VEH_ANNEE="&VEH_ANNEE=".$user_voiture->annee;
					$VEH_VERSION="&VEH_VERSION=".$user_voiture->modele;
					//$VEH_OPTIONS="";;
					//$VEH_USAGE="";;
					$VEH_KILOM="&VEH_KILOM=".$user_voiture->kilometrage;
					//$INT_REPRISE="";;
					$VEH_IMMAT="&VEH_IMMAT=".$user_voiture->immatriculation;
					$VEH_CHASSIS="";;
					//$VEH_ARGUS="";;
					//$VEH_DT_PRIM_IMMAT="";;
					$VEH_ENERGIE="&VEH_ENERGIE=".$user_voiture->energie;
					$VEH_MARQUE="&VEH_MARQUE=".$user_voiture->marque;
					$VEH_MODELE="&VEH_MODELE=".$user_voiture->modele;
					$veh = $VEH_ANNEE.$VEH_VERSION.$VEH_KILOM.$VEH_IMMAT.$VEH_CHASSIS.$VEH_ENERGIE.$VEH_MARQUE.$VEH_MODELE;
				}
				else
				{
					$veh = "";
				}

				//PAS ENCORE DE COMMENTAIRE EN ACHAT
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString($commentaireAdd . "Demande d'achat", 255);

				//CONTRUCTION DE LA PARTIE SPECIFIQUE
				$url_suffix = $dclicom_contact_pref . $dclicom_marque . $dclicom_modele . $dclicom_vin . $dclicom_carrosserie;
				$url_suffix.= $dclicom_semiclair . $dclicom_tarif_origine . $dclicom_energie.$veh;
				$url_suffix.= $dclicom_service . $dclicom_fin . $dclicom_prix . $dclicom_version . $dclicom_commentaire;

				break;

			case 'boutique_vo':
				$model = JModel::getInstance('leadachatvo', 'RrgDevModel');
				$modelEtab = JModel::getInstance('Etablissement', 'RrgDevModel');
				$modelCommande = JModel::getInstance('Commande', 'RrgDevModel');
				$modelUser = JModel::getInstance('user', 'RrgDevModel');
				$user = $modelUser->getUser($modelUser->getUserId());
				$vo = $model->getObjectif();
				$commande = $modelCommande->getItem();
				$tmp_dealer_id = $modelEtab->getDealerIdByCompteDistribution($vo->compte_distribution_id);
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE='. $helper_lmt_decript['server'][$type]['sous_demande'];
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				//CONTACT PREF
				$tmp = ($dclispec_optin) ? 'True' : 'False';
				$dclicom_contact_pref = '&DCLISPEC_CONTACT_EMAIL=' . $tmp;
				//VEH_CLIENT
				$dclicom_basket= "&INT_BASKET=".$vo->modele;

				//PAS ENCORE DISPONNIBLE
				//$dclicom_chassis= "&INT_CHASSIS=";
				//$dclicom_contrat_service= "&INT_CONTRACT_SERVICE=";
				//$dclicom_promotion= "&INT_PROMOTION=";
				//$dclicom_offer= "&INT_OFFER=";

				// Récupération INFO Spécifique à ce lead
				//OBJECTIF
				$dclicom_semiclair= "&INT_SEMICLAIR=".$vo->version;
				$dclicom_tarif_origine= "&INT_TARIF_ORIGINE=".$vo->numero_tarif;
				$dclicom_energie= "&INT_ENERGIE".$vo->energie;
				$dclicom_marque = '&INT_MARQUE=' . $this->formatString($vo->marque, 50);
				$dclicom_modele = '&INT_MODELE=' . $this->formatString($vo->modele, 50);
				$dclicom_carrosserie = '&INT_CARROSSERIE='.$this->formatString($vo->categorie, 50);
				$dclicom_vin = '&INT_CHASSIS=' . $this->formatString($vo->vin, 50);
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . $this->formatString(JRequest::getInt('contrats'), 50);
				$dclicom_fin = '&INT_FIN=' . $this->formatString(JRequest::getInt('financement'), 50);
				$dclicom_prix = '&INT_PRICE=' . $this->formatString($vo->prix_ttc, 50);
				$dclicom_version = '&INT_VERSION=' . $this->formatString($vn->version, 50);

				//ON prend la premiere voiture comme voiture par défaut.
				if($user->vehicules['0'] != null)
				{
					$user_voiture = $user->vehicules['0'];
					//die(var_dump($user_voiture));
					//Alors on peut remplir les information de vehicule possedé
					$VEH_ANNEE="&VEH_ANNEE=".$user_voiture->annee;
					$VEH_VERSION="&VEH_VERSION=".$user_voiture->modele;
					//$VEH_OPTIONS="";
					//$VEH_USAGE="";
					$VEH_KILOM="&VEH_KILOM=".$user_voiture->kilometrage;

					$VEH_IMMAT="&VEH_IMMAT=".$user_voiture->immatriculation;
					$VEH_CHASSIS="";
					//$VEH_ARGUS="";
					//$VEH_DT_PRIM_IMMAT="";
					$VEH_ENERGIE="&VEH_ENERGIE=".$user_voiture->energie;
					$VEH_MARQUE="&VEH_MARQUE=".$user_voiture->marque;
					$VEH_MODELE="&VEH_MODELE=".$user_voiture->modele;
					$veh = $VEH_ANNEE.$VEH_VERSION.$VEH_KILOM.$VEH_IMMAT.$VEH_CHASSIS.$VEH_ENERGIE.$VEH_MARQUE.$VEH_MODELE;
				}
				else
				{
					$veh = "";
				}

				if (JRequest::getString('operation') == 'sslo') {
					$dclispec_lead_campagne = '&CAMPAIGN=SAUTEZ SUR L\'OCCASION ETE-2012';
						
				} else {
					$dclispec_lead_campagne = '&CAMPAIGN=Nom de campagne';
				}

				//PAS ENCORE DE COMMENTAIRE EN ACHAT
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString($commentaireAdd . "Demande d'achat", 255);
				//Toujours a non pour la boutique.(pour l'instant)
				$INT_REPRISE="&INT_REPRISE=N";

				//CONTRUCTION DE LA PARTIE SPECIFIQUE
				$url_suffix = $dclicom_contact_pref . $dclicom_marque . $dclicom_modele . $dclicom_vin . $dclicom_carrosserie;
				$url_suffix.= $dclicom_semiclair . $dclicom_tarif_origine . $dclicom_energie.$veh . $INT_REPRISE;
				$url_suffix.= $dclicom_service . $dclicom_fin . $dclicom_prix . $dclicom_version . $dclicom_commentaire;
				break;
			case 'vo':
				$model = JModel::getInstance('Vo', 'RrgDevModel');
				$vo = $model->getItemById(JRequest::getInt('id'));
				//Récupération du commentaire additionnel
				$rofs = JRequest::getString('offre');
				//Récupération de l'opération rofs sur le véhicule
				$commentaireAdd = $this->miseEnFormeSsDem();

				if ($rofs == 'rofs') {
					$commentaireAdd .= '[Soldes Renault]';
				}
				$tmp_dealer_id = $vo->etab_dealer_id;
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6ESSAI';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				// Récupération INFO Spécifique à ce lead
				$dclicom_marque = '&INT_MARQUE=' . $this->formatString($vo->marque, 50);
				$dclicom_modele = '&INT_MODELE=' . $this->formatString($vo->motorisation . ' ' . $vo->version, 50);
				$usedcarnb = '&usedcarnb=' . $this->formatString($vo->immatriculation, 50);
				$dclicom_carrosserie = '&INT_CARROSSERIE='.$this->formatString($vo->categorie, 50);
				$dclicom_price = '&INT_PRICE=' . substr($vo->prix, 0, 50);
				$dclicom_km = '&km=' . substr($vo->kilometrage, 0, 50);
				$dclicom_annee = '&year =' . substr($vo->date_madc, 0, 50);
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . JRequest::getInt('contrats');
				$dclicom_fin = '&INT_FIN=' . substr(JRequest::getInt('financement'), 0, 50);
				$dclicom_energie= "&INT_ENERGIE".$vn->energie;
				$dclicom_info_comp_cli = '&DCLISPEC_INFO_COMP_CLI=' . $this->formatString($commentaireAdd . JRequest::getString('commentaire'), 255);
				$url_suffix  = $dclicom_marque . $dclicom_modele . $usedcarnb . $dclicom_price . $dclicom_carrosserie ;
				$url_suffix .= $dclicom_km . $dclicom_annee . $dclicom_service . $dclicom_fin . $dclicom_info_comp_cli;

				break;
			case 'sslo':
				$model = JModel::getInstance('Vo', 'RrgDevModel');
				$vo = $model->getItemById(JRequest::getInt('id'));

				$tmp_dealer_id = $vo->etab_dealer_id;

				// specifique sur la personne :
				$dclicom_n_tel_dom = '&DCLICOM_N_TEL_DOM=' . $this->formatString(JRequest::getString('telephone'), 255);
				$url_origin = '&CONTEXT=F6rrg';

				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6ACHAT';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=VO';
				if (JRequest::getString('operation') == 'sslo') {
					$dclispec_lead_campagne = '&CAMPAIGN=SAUTEZ SUR L\'OCCASION ETE-2012';
						
				} else {
					$dclispec_lead_campagne = '&CAMPAIGN=Nom de campagne';
				}


				//CONTACT PREF
				$tmp = ($dclispec_optin) ? 'True' : 'False';
				$dclicom_contact_pref = '&DCLISPEC_CONTACT_EMAIL=' . $tmp;
				//VEH_CLIENT
				$dclicom_basket= "&INT_BASKET=".$this->formatString($vo->motorisation . ' ' . $vo->version, 50);

				//PAS ENCORE DISPONNIBLE
				//$dclicom_chassis= "&INT_CHASSIS=";
				//$dclicom_contrat_service= "&INT_CONTRACT_SERVICE=";
				//$dclicom_promotion= "&INT_PROMOTION=";
				//$dclicom_offer= "&INT_OFFER=";

				// Récupération INFO Spécifique à ce lead
				//OBJECTIF
				$dclicom_semiclair= "&INT_SEMICLAIR=".$vo->version;
				$dclicom_tarif_origine= "&INT_TARIF_ORIGINE=".$vo->numero_tarif;
				$dclicom_energie= "&INT_ENERGIE=".$vo->energie;
				$dclicom_marque = '&INT_MARQUE=' . $this->formatString($vo->marque, 50);
				$dclicom_modele = '&INT_MODELE=' . $this->formatString($vo->motorisation . ' ' . $vo->version, 50);
				$dclicom_carrosserie = '&INT_CARROSSERIE='.$this->formatString($vo->categorie, 50);
				$dclicom_vin = '&INT_CHASSIS=' . $this->formatString($vo->vin, 50);
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . $this->formatString(JRequest::getInt('contrats'), 50);
				$dclicom_fin = '&INT_FIN=' . $this->formatString(JRequest::getInt('financement'), 50);
				$dclicom_prix = '&INT_PRICE=' . $this->formatString($vo->prix, 50);
				$dclicom_version = '&INT_VERSION=' . $this->formatString($vo->version, 50);

				// l'user n'a pas de voiture par default
				$veh = "";

				//PAS ENCORE DE COMMENTAIRE EN ACHAT
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString(JRequest::getString('commentaire'), 255);
				//Toujours a non pour la boutique.(pour l'instant)
				$int_reprise="&INT_REPRISE=N";

				//CONTRUCTION DE LA PARTIE SPECIFIQUE
				$url_suffix = $int_reprise . $dclicom_n_tel_dom . $dclicom_contact_pref . $dclicom_marque . $dclicom_modele . $dclicom_vin . $dclicom_carrosserie;
				$url_suffix.= $dclicom_semiclair . $dclicom_tarif_origine . $dclicom_energie.$veh;
				$url_suffix.= $dclicom_service . $dclicom_fin . $dclicom_prix . $dclicom_version . $dclicom_commentaire . $dclispec_lead_campagne;
				break;
			case 'vn_brochure':
				$modelEtab = JModel::getInstance('Etablissement', 'RrgDevModel');
				$modelVn = JModel::getInstance('Vn', 'RrgDevModel');
				$vn = $modelVn->getItemById(JRequest::getString('id'));
				$tmp_dealer_id = $modelEtab->getDealerIdByCompteDistribution($vn->compte_distribution_id);
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6BROCHU';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				// Récupération INFO Spécifique à ce lead
				$tmp = (JRequest::getString('contact_pref') == 'mail') ? 'True' : 'False';
				$dclicom_contact_pref = '&DCLISPEC_CONTACT_EMAIL=' . $tmp;
				$dclicom_demande_brochure = '&DCLISPEC_DEMANDE_BROCHURE=True';
				$dclicom_vin = '&INT_CHASSIS=' . $this->formatString($vn->vin, 50);
				$dclicom_carrosserie = '&INT_CARROSSERIE='.$this->formatString($vn->categorie, 50);
				$dclicom_marque = '&INT_MARQUE=' . $this->formatString($vn->marque, 50);
				$dclicom_modele = '&INT_MODELE=' . $this->formatString($vn->modele . ' ' . $vn->version, 50);
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . $this->formatString(JRequest::getInt('contrats'), 50);
				$dclicom_fin = '&INT_FIN=' . $this->formatString(JRequest::getInt('financement'), 50);
				$dclicom_prix = '&INT_TARIF_REMISE=' . $this->formatString($vn->prix_ttc, 50);
				$url_suffix = $dclicom_contact_pref . $dclicom_demande_brochure . $dclicom_demande_brochure. $dclicom_carrosserie ;
				$url_suffix.= $dclicom_marque . $dclicom_modele . $dclicom_vin . $dclicom_service . $dclicom_fin . $dclicom_prix;

				break;

			case 'vn':
				$modelEtab = JModel::getInstance('Etablissement', 'RrgDevModel');
				$modelVn = JModel::getInstance('Vn', 'RrgDevModel');

				//$modelDealer = JModel::getInstance($type, $config)
				$vn = $modelVn->getItemById(JRequest::getString('id'));
				//Récupération du commentaire additionnel
				$commentaireAdd = $this->miseEnFormeSsDem();
				$tmp_dealer_id = $modelEtab->getDealerIdByCompteDistribution($vn->compte_distribution_id);
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6ESSAI';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				// Récupération INFO Spécifique à ce lead
				$tmp = (JRequest::getString('contact_pref') == 'mail') ? 'True' : 'False';
				$dclicom_contact_pref = '&DCLISPEC_CONTACT_EMAIL=' . $tmp;
				$dclicom_marque = '&INT_MARQUE=' . $this->formatString($vn->marque, 50);
				$dclicom_modele = '&INT_MODELE=' . $this->formatString($vn->modele, 50);
				$dclicom_carrosserie = '&INT_CARROSSERIE='.$this->formatString($vn->categorie, 50);
				$dclicom_vin = '&INT_CHASSIS=' . $this->formatString($vn->vin, 50);
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . $this->formatString(JRequest::getInt('contrats'), 50);
				$dclicom_fin = '&INT_FIN=' . $this->formatString(JRequest::getInt('financement'), 50);
				$dclicom_prix = '&INT_TARIF_REMISE=' . $this->formatString($vn->prix_ttc, 50);
				$dclicom_version = '&INT_VERSION=' . $this->formatString($vn->version, 50);
				$dclicom_energie= "&INT_ENERGIE".$vn->energie;
				// Usage pas encore disponnible
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString($commentaireAdd . JRequest::getString('commentaire'), 255);
				$url_suffix = $dclicom_contact_pref . $dclicom_marque . $dclicom_modele . $dclicom_vin . $dclicom_carrosserie;
				$url_suffix.= $dclicom_energie . $dclicom_service . $dclicom_fin . $dclicom_prix . $dclicom_version . $dclicom_commentaire;

				break;

			case 'apv_standart':

				$modelApv = JModel::getInstance('LeadApv', 'RrgDevModel');
				$modelEtab = JModel::getInstance('Etablissement', 'RrgDevModel');

				$etab = $modelEtab->getItemByEtabId();
				$tmp_dealer_id = $etab->dealer_id;
				// On découpe la date de l'heure ils sont séparer par un espace
				$date = explode(' ', $modelApv->getRdvDate());
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6ATELIERENTR';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				// Récupération INFO Spécifique à ce lead
				$dclicom_marque = '&VEH_MARQUE=' . $this->formatString(JRequest::getString('marque'), 50);
				$dclicom_modele = '&VEH_MODELE=' . $this->formatString(JRequest::getString('modele'), 50);
				$dclicom_immat = '&VEH_IMMAT=' . $this->formatString(JRequest::getString('immatriculation'), 50);
				$dclicom_date_rdv = '&DT_INT_RDV_SBOL_DT=' . WebFormHelper::getConvertLmtDate($date[0]);
				$dclicom_heure_rdv = '&INT_HR_INT=' . $date[1];
				// @todo : demander si c'est normal une promo dans un rdv classique
				$dclicom_promo = '&INT_PROMOTION=' . $this->formatString($modelApv->getInterventionsContent(implode(',', JRequest::getVar('interventions'))), 50);
				$dclicom_prestation_apv = '&PRESTATION_APV=' . $this->formatString($modelApv->getInterventionsContent(implode(',', JRequest::getVar('interventions'))), 50);
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString(JRequest::getString('commentaire'), 255);
				$url_suffix  = $dclicom_marque . $dclicom_modele . $dclicom_immat . $dclicom_date_rdv ;
				$url_suffix .= $dclicom_heure_rdv . $dclicom_promo . $dclicom_prestation_apv . $dclicom_commentaire;

				break;

			case 'apv_promos':

				$modelApv = JModel::getInstance('LeadApv', 'RrgDevModel');
				$modelEtab = JModel::getInstance('Etablissement', 'RrgDevModel');

				$etab = $modelEtab->getItemByEtabId();
				$tmp_dealer_id = $etab->dealer_id;
				// On découpe la date de l'heure il sont séparer par un espace
				$date = explode(' ', $modelApv->getRdvDate(JRequest::getString('choix')));
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=' . $helper_lmt_decript['server'][$type]['sous_demande'];
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				// Récupération INFO Spécifique à ce lead
				$dclicom_marque = '&VEH_MARQUE=' . $this->formatString(JRequest::getString('marque'), 50);
				$dclicom_modele = '&VEH_MODELE=' . $this->formatString(JRequest::getString('modele'), 50);
				$dclicom_immat = '&VEH_IMMAT=' . $this->formatString(JRequest::getString('immatriculation'), 50);
				//$dclicom_date_rdv = '&INT_DT_INT=' . WebFormHelper::getConvertLmtDate($date[0]);
				$dclicom_date_rdv = '&DT_INT_RDV_SBOL_DT=' . WebFormHelper::getConvertLmtDate($date[0]);
				$dclicom_heure_rdv = '&INT_HR_INT=' . $date[1];
				// @todo : demander si c'est normal une promo dans un rdv classique
				$buff_promo = $this->formatString($modelApv->getPromoContent($modelApv->getPromoId()), 50);
				$buff_nom = $this->formatString($modelApv->getPromoName($modelApv->getPromoId()), 50);
				$dclicom_promo = '&INT_PROMOTION=' . $buff_promo;
				$dclicom_prestation_apv = '&PRESTATION_APV=' . $buff_nom;
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString('[PROMO] : ' . $buff_nom . '. [Commentaire] : ' . JRequest::getString('commentaire'), 255);
				$url_suffix = $dclicom_marque . $dclicom_modele . $dclicom_immat . $dclicom_prestation_apv ;
				$url_suffix .= $dclicom_date_rdv . $dclicom_heure_rdv . $dclicom_promo . $dclicom_commentaire;

				break;

			case 'demande_generale':
				$buff = '[DEMANDE GENERALE]';

				if (JRequest::getString('option') == 'com_rrg_etablissements') {
					$buff = '[[' . JRequest::getString('etab_nom') . ']][' . JRequest::getString('service_nom') . ']';
				}elseif (JRequest::getString('view') == 'agentsorleans'){
					$buff = '[AGENTS_ORLEANS]';
				}elseif (JRequest::getString('view') == 'twizy'){
					$buff = '[OPO Twizy du 19-23 avril]';
				}
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6CONCESSION';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString($buff . JRequest::getString('commentaire'), 255);
				$url_suffix = $dclicom_commentaire;

				break;

			case 'ze':
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6CONCESSION';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server']['demande_generale']['lead_type'];
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString('[ZE-' . JRequest::getString('type_demande') . '-' . JRequest::getString('modele') . ']' . JRequest::getString('commentaire'), 255);
				$url_suffix = $dclicom_commentaire;

				break;

			case 'contrat_services':
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE='.$helper_lmt_decript['server']['demande_generale']['sous_demande'];
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server']['contrat_service']['lead_type'];
				$dclicom_veh_marque = '&VEH_MARQUE='.'F6RENAULT';
				$dclicom_contrat_service = '&CONTRACT_SERVICE='.JRequest::getString('contrat');
				$dclicom_contrat_service_kilom = '&CONTRACT_SERVICE_KILOM='.JRequest::getString('contrat');
				$dclispec_info_comp_cli = '&DCLISPEC_INFO_COMP_CLI='.'vide';
				$dclicom_veh_version = '&VEH_VERSION='.JRequest::getString('version');
				$dclicom_veh_modele  = '&VEH_MODELE='.JRequest::getString('voiture');
				$dclicom_contrat_service_duration = '&CONTRACT_SERVICE_DURATION='.JRequest::getVar('valeur');
				$dclicom_veh_energie = '&VEH_ENERGIE='.JRequest::getString('energie');
				$dclicom_commentaire = '&INT_COMMENTAIRE=[CONTRATSERVICES]' . '&Etablissement:' . $this->formatString(urlencode(JRequest::getString('etablissement')) . '&Contrat:' . urlencode(JRequest::getString('contrat')) . '&Valeur:' . urlencode(JRequest::getString('valeur')) . '&Voiture:' . urlencode(JRequest::getString('voiture')) . '&Version:' . urlencode(JRequest::getString('version')) . '&Energie:' . urlencode(JRequest::getString('energie')), 255);
				$url_suffix = $dclicom_commentaire . $dclicom_veh_marque . $dclicom_contrat_service .$dclicom_contrat_service_kilom;
				$url_suffix .= $dclispec_info_comp_cli.$dclicom_veh_version.$dclicom_veh_modele.$dclicom_contrat_service_duration.$dclicom_veh_energie;
				break;

			case 'dacia_promo':
				//Récupération du commentaire additionnel
				$commentaireAdd = JRequest::getString('affaire'); //l'établissement
				$tmp_dealer_id = 'DEALER_00001265_001';
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6ESSAI';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				// Récupération INFO Spécifique à ce lead
				$tmp = (JRequest::getString('contact_pref') == 'mail') ? 'True' : 'False';
				$dclicom_contact_pref = '&DCLISPEC_CONTACT_EMAIL=' . $tmp;
				$dclicom_marque = '&INT_MARQUE=' . urlencode("Dacia");
				$dclicom_modele = '&INT_MODELE=' . urlencode("Duster");
				$dclicom_vin = '&INT_CHASSIS=' . urlencode("UU111111111111111");
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . urlencode(0);
				$dclicom_fin = '&INT_FIN=' . urlencode(0);
				$dclicom_prix = '&INT_TARIF_REMISE=' . urlencode(11990);
				$dclicom_version = '&INT_VERSION=' . urlencode("DESTOCKAGE POLE DUSTER FEV 2012");
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString(urlencode($commentaireAdd . JRequest::getString('commentaire')), 50);
				$url_suffix = $dclicom_contact_pref . $dclicom_marque . $dclicom_modele . $dclicom_vin . $dclicom_service . $dclicom_fin . $dclicom_prix . $dclicom_version . $dclicom_commentaire;

				break;

			case 'agents_orleans':
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6CONCESSION';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server']['demande_generale']['lead_type'];
				$dclicom_commentaire = '&INT_COMMENTAIRE=[AGENTS_ORLEANS]' . $this->formatString(JRequest::getString('commentaires'), 255);
				$url_suffix = $dclicom_commentaire;
				break;

				//mini-site Twizy Paris
			case 'twizy':
				//inclusion WebFormHelper
				require_once(JPATH_ADMINISTRATOR . DS . 'components' . DS . 'com_rrgdev' . DS . 'models' . DS . 'essaize.php');
				//Récupération du commentaire additionnel
				$commentaireAdd = $this->miseEnFormeSsDem();
				$modelEssaiZe = JModel::getInstance('EssaiZe', 'RrgDevModel');
				$tmp_dealer_id = $modelEssaiZe->getWebFormDealerIdByAlias();
				// TYPE & WEBFORM_ID// Info spécifique au lead
				$dclispec_sous_demande = '&DCLISPEC_SOUS_DEMANDE=F6ESSAI';
				$dclispec_lead_type = '&DCLISPEC_LEAD_TYPE=' . $helper_lmt_decript['server'][$type]['lead_type'];
				// Récupération INFO Spécifique à ce lead
				$tmp = (JRequest::getString('contact_pref') == 'mail') ? 'True' : 'False';
				$dclicom_contact_pref = '&DCLISPEC_CONTACT_EMAIL=' . $tmp;
				$dclicom_marque = '&INT_MARQUE=Renault' ;
				$dclicom_modele = '&INT_MODELE=Twizy';
				$dclicom_vin = '&INT_CHASSIS=VF1ACVY0000000000';
				$dclicom_service = '&INT_CONTRACT_SERVICE=' . urlencode(0);
				$dclicom_fin = '&INT_FIN=' . urlencode(0);
				$dclicom_prix = '&INT_TARIF_REMISE=' . urlencode(7788);
				$dclicom_version = '&INT_VERSION=' . urlencode("à définir");
				$dclicom_commentaire = '&INT_COMMENTAIRE=' . $this->formatString($commentaireAdd . JRequest::getString('commentaire'), 255);
				$url_suffix = $dclicom_contact_pref . $dclicom_marque . $dclicom_modele . $dclicom_vin . $dclicom_service . $dclicom_fin . $dclicom_prix . $dclicom_version . $dclicom_commentaire;

				break;
			default:
				return false;
		}
		//Cas par default LMT
		if (empty($tmp_dealer_id)) {
			$tmp_dealer_id .= WebFormHelper::getDefaultDealerId();
		}
		$webform_dealer_id .= $tmp_dealer_id;
		$url = $url_base . $idwebform . $url_origin . $url_params_dur . $info_personne . $meta_constructor . $dclispec_optin;
		$url .= $dclispec_sous_demande . $dclispec_lead_type . $webform_dealer_id;
		$url .= $url_suffix;
<<<<<<< .mine
		die(var_dump($url));
=======

>>>>>>> .r6395
		return $url;
	}

}

